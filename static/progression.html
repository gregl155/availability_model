<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Availability Progression</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      label { font-weight: 600; }
      input, button { padding: 6px 10px; font-size: 14px; }
      #chart-wrap { margin-top: 20px; }
    </style>
  </head>
  <body>
    <h2>Availability Progression for a Check-in Date</h2>
    <div class="row">
      <label for="checkin">Check-in date:</label>
      <input id="checkin" type="date" value="2025-09-13" />
      <label for="z">Band z-threshold:</label>
      <input id="z" type="number" step="0.1" value="2.0" />
      <button id="load">Load</button>
    </div>
    <div id="status"></div>
    <div id="chart-wrap">
      <canvas id="chart" height="100"></canvas>
    </div>

    <script>
      const ctx = document.getElementById('chart').getContext('2d');
      let chart;

      function fmtDate(d) {
        return new Date(d).toLocaleDateString();
      }

      async function loadData() {
        const ci = document.getElementById('checkin').value;
        const z = document.getElementById('z').value;
        document.getElementById('status').textContent = 'Loading...';
        try {
          const res = await fetch(`/api/progression?check_in=${encodeURIComponent(ci)}&z=${encodeURIComponent(z)}`);
          const data = await res.json();
          if (!res.ok) {
            document.getElementById('status').textContent = data.error || 'Error';
            return;
          }
          document.getElementById('status').textContent = '';

          const labels = data.points.map(p => p.parse_date);
          const observed = data.points.map(p => p.observed);
          const baseline = data.points.map(p => p.baseline);
          const lo = data.points.map(p => p.lo);
          const hi = data.points.map(p => p.hi);

          if (chart) chart.destroy();
          chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Observed',
                  data: observed,
                  borderColor: '#1f77b4',
                  backgroundColor: 'rgba(31,119,180,0.2)',
                  tension: 0.2,
                },
                {
                  label: 'Baseline',
                  data: baseline,
                  borderColor: '#2ca02c',
                  backgroundColor: 'rgba(44,160,44,0.2)',
                  borderDash: [5,4],
                  tension: 0.2,
                },
                {
                  label: 'Lower band',
                  data: lo,
                  borderColor: 'rgba(44,160,44,0.4)',
                  borderDash: [2,2],
                  pointRadius: 0,
                },
                {
                  label: 'Upper band',
                  data: hi,
                  borderColor: 'rgba(44,160,44,0.4)',
                  borderDash: [2,2],
                  pointRadius: 0,
                },
              ]
            },
            options: {
              plugins: {
                title: { display: true, text: `Progression to ${data.check_in}` },
                legend: { position: 'bottom' },
              },
              scales: {
                x: { title: { display: true, text: 'Snapshot parse date' } },
                y: { title: { display: true, text: 'Total available rooms' }, beginAtZero: true }
              }
            }
          });
        } catch (e) {
          document.getElementById('status').textContent = 'Error loading data';
        }
      }

      document.getElementById('load').addEventListener('click', loadData);
      // Auto-load initial value
      loadData();
    </script>
  </body>
  </html>


